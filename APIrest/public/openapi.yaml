openapi: 3.0.3

info:
  title: CRM API
  version: "1.0.0"
  description: |
    CRM REST API

      This API provides access to a Customer Relationship Management (CRM) system designed to manage clients and their related activities in a structured and secure way. It exposes a set of RESTful endpoints that allow authenticated users to create, read, update, and delete domain resources while enforcing strict ownership and authorization rules.
      The API is intended to be consumed by frontend applications and third-party services that require reliable access to CRM data, with a strong emphasis on consistency, clarity, and predictable behavior.
      
      Authorization

       - All protected endpoints require authentication using a Bearer token.

       - Authentication is mandatory for accessing any domain resource.

       - Users with the admin role have global access and can view and manage all resources in the system.

       - Users with the user role are restricted to accessing only the resources they own.

       - When an authenticated user attempts to access a resource without sufficient permissions, the API responds with 403 Forbidden.

      General Behavior

      The API follows standard REST principles and uses conventional HTTP status codes to communicate the result of each request. All responses are returned in JSON format, including error responses, which are structured and consistent across the API to simplify client-side handling and debugging.
      This documentation serves as the single source of truth for the API contract. The behavior described here is enforced by automated tests, and documentation must always remain aligned with the actual implementation.


servers:
  - url: /api/v1

tags:
  - name: Authentication
    description: Authentication and identity endpoints.
  - name: Clients
    description: Client management endpoints.
  - name: Activities
    description: Activity management endpoints.

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Role:
      type: object
      description: |
        # Roles

          Defines the authorization level of the user within the system.

          Roles determine which actions a user is allowed to perform
          and which API endpoints they can access.

          Each role grants access to a specific set of API capabilities:

          - user:
            Can authenticate and access their own resources.
            Can view their own user profile (/users/me).
            Cannot list users or access other users' data.

          - admin:
            Has elevated privileges across the system.
            Can list users and access any user profile.
            Can access administrative and management endpoints.

          Roles are assigned and managed internally by the system
          and cannot be modified by regular users.
      enum: [admin, user]

    Rest principles:
      type: object
      description: |
        # REST Principles and API Conventions

          This API strictly follows REST principles. Deviations without explicit justification are not permitted.

          ## Mandatory Rules
          - The API is stateless (sessions are not used).

          - JSON is the only accepted format for requests and responses.

          - Resources are named in the plural.

          - Examples: `/clients`, `/activities`, `/users`
          - Correct use of HTTP verbs:

          - GET: retrieve resources

          - POST: create resources

          - PATCH: partially update

          - DELETE: delete resources

          ## Design Conventions
          - Each endpoint represents a resource, not an action.

          - RPC-style endpoints (`/doSomething`, `/createClientNow`) are not allowed.

          ## Justification
          These rules ensure:
          - Consistency across endpoints
          - Ease of testing
          - Better documentation (OpenAPI, Postman)
          - Better integration with frontends and third parties

          ## API Base Path and Versioning

          All endpoints are exposed under the following base path:

          /api/v1

          Any change that breaks backward compatibility requires a new version.

          ## Allowed HTTP Status Codes

          The API uses a limited and explicit set of HTTP status codes:

          - 200 OK: Successful read or update
          - 201 Created: Resource successfully created
          - 204 No Content: Resource successfully deleted
          - 401 Unauthorized: Request lacks valid authentication
          - 403 Forbidden: Authenticated but not allowed to perform this action
          - 404 Not Found: Resource does not exist or is not accessible
          - 422 Unprocessable Entity: Validation errors

          No other status codes are allowed unless explicitly justified.

          ## Authorization Rules

          The API distinguishes between two roles:

          - user: can only access resources they own
          - admin: has global access to all resources

          Each endpoint must explicitly state which roles are allowed and how ownership is enforced.

          ## Contract Authority

          All HTTP contracts defined under docs/api must comply with the rules defined in this document.

          Any endpoint that violates these principles is considered invalid.

    Api versioning:
      type: object
      description: |
        # API Versioning

          ## Convention
          All API routes must be versioned under the path:

          /api/v1/...

          Example:

          /api/v1/clients

          ## Justification
          - Avoids silent breaking changes.

          - Allows for API evolution without breaking existing integrations.

          - Almost no initial cost, high long-term value.

          ## Discarded Alternatives
          - Versioning by headers:

          - Greater friction on the frontend.

          Less visibility in tools like Postman or Swagger.

          ## Note
          Currently, only `v1` exists, but the convention applies from the first endpoint.

    Error handling:
      type: object
      description: |
          # Error Handling and Status Codes

          The API must respond consistently to errors.

          ## Allowed Status Codes
          - 200 OK
          - 201 Created
          - 400 Bad Request
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found
          - 422 Unprocessable Entity (validations)
          - 500 Internal Server Error

          ## Key Rule
          Always returning `200` with a `success=false` flag is not allowed.

          HTTP semantics must be respected.

          ## Standard Error Structure
          Errors must include:
          - A clear message for the frontend
          - Useful information for debugging (when applicable)

          /*```json
          {
            "message": "string",
            "details": null | { "fields": { "field": ["error"] } }
          }
          */


            ## Rationale
            - Allows the frontend to handle errors deterministically.

            - Facilitates automated testing.

            - Improves observability and maintainability.

    Activities:
      type: object
      description: |
        # Activities API Contract

          ## Resource Description

          The activities resource represents actions or events performed in the context of a client.
          Each activity belongs to a client, and indirectly to a user through that client.

          Activities are exposed as a top-level resource.
          Ownership and access control are enforced via authorization rules, not URL nesting.


          ## Endpoints

          ### GET /api/v1/activities

          **Purpose**  
          List all activities accessible to the authenticated user.

          **Authorization**
          - user: only activities belonging to the user’s own clients
          - admin: all activities

          **Status Codes**
          - 200 OK
          - 401 Unauthorized


          ### POST /api/v1/activities

          **Purpose**  
          Create a new activity.

          **Authorization**
          - user: only for clients owned by the user
          - admin: for any client

          **Notes**
          - `client_id` is required
          - `user_id` is derived from the client and cannot be provided by the request

          **Status Codes**
          - 201 Created
          - 401 Unauthorized
          - 403 Forbidden
          - 422 Unprocessable Entity


          ### GET /api/v1/activities/{activityId}

          **Purpose**  
          Retrieve a single activity by its identifier.

          **Authorization**
          - user: only if the activity belongs to one of the user’s clients
          - admin: any activity

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found


          ### PATCH /api/v1/activities/{activityId}

          **Purpose**  
          Partially update an existing activity.

          **Authorization**
          - user: only if the activity belongs to one of the user’s clients
          - admin: any activity

          **Notes**
          - Partial updates only (`PATCH`)
          - Validation rules use `sometimes`
          - Only validated fields are updated
          - `client_id` and `user_id` cannot be modified

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found
          - 422 Unprocessable Entity


          ### DELETE /api/v1/activities/{activityId}

          **Purpose**  
          Delete an existing activity.

          **Authorization**
          - user: only if the activity belongs to one of the user’s clients
          - admin: any activity

          **Status Codes**
          - 204 No Content
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 10
        client_id:
          type: integer
          example: 5
        description:
          type: string
          example: "Called the client to confirm requirements"
        created_at:
          type: string
          format: date-time
          example: "2026-01-28T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-28T10:00:00Z"

    Clients:
      type: object
      description: |
        # Clients API Contract

          ## Resource Description

          The clients resource represents a collection of clients managed by the system.
          Each client belongs to a user, unless accessed by an admin with global privileges.


          ## Endpoints

          ### GET /api/v1/clients

          **Purpose**  
          List all clients accessible to the authenticated user.

          **Authorization**
          - user: only own clients
          - admin: all clients

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden


          ### POST /api/v1/clients

          **Purpose**  
          Create a new client.

          **Authorization**
          - user
          - admin

          **Status Codes**
          - 201 Created
          - 401 Unauthorized
          - 422 Unprocessable Entity


          ### GET /api/v1/clients/{clientId}

          **Purpose**  
          Retrieve a single client by its identifier.

          **Authorization**
          - user: only if the client is owned by the user
          - admin: any client

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found


          ### PATCH /api/v1/clients/{clientId}

          **Purpose**  
          Update an existing client.

          **Authorization**
          - user: only if the client is owned by the user
          - admin: any client

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found
          - 422 Unprocessable Entity


          ### DELETE /api/v1/clients/{clientId}

          **Purpose**  
          Delete an existing client.

          **Authorization**
          - user: only if the client is owned by the user
          - admin: any client

          **Status Codes**
          - 204 No Content
          - 401 Unauthorized
          - 403 Forbidden
          - 404 Not Found


          ## Request Payloads and Validation

          ### Create Client (POST)

          Accepted fields:

          - `name` (required, string)
          - `email` (required, valid email)
          - `phone` (optional, string)
          - `address` (optional, string)

          Notes:
          - `user_id` is NOT accepted from the request body.
          - Ownership is always assigned from the authenticated user.

          Validation Errors:
          - Invalid payload returns **422 Unprocessable Entity**.

          ### Update Client (PATCH)

          Partial updates are supported.

          Accepted fields (all optional):

          - `name` (string)
          - `email` (valid email)
          - `phone` (string)
          - `address` (string)

          Validation Errors:
          - Invalid fields return **422 Unprocessable Entity**.


          ## Error Handling Strategy

          The following rules apply consistently to all client endpoints:

          - **401 Unauthorized**
            - Request without a valid access token.

          - **403 Forbidden**
            - Authenticated user attempting to access a client they do not own.
            - Applies even if the resource exists.

          - **404 Not Found**
            - Client does not exist.
            - Handled automatically by route model binding.

          - **422 Unprocessable Entity**
            - Validation errors.
            - Takes precedence over authorization errors for authenticated users.

          cat >> docs/api/clients.md <<'MD'


          ## Testing as Contract

          The behavior described in this document is enforced by automated feature tests.

          Tests cover:

          - Authentication requirements
          - Ownership and role-based authorization
          - Correct HTTP status codes
          - Validation rules
          - Database side effects

          No endpoint is considered valid unless all related tests are passing.
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 10
        name:
          type: string
          example: Acme Corp
        email:
          type: string
          nullable: true
          example: contact@acme.com
        phone:
          type: string
          nullable: true
          example: "+34 600 000 000"
        address:
          type: string
          nullable: true
          example: "Calle Mayor 1, Madrid"
        created_at:
          type: string
          format: date-time
          example: "2026-01-28T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-28T10:00:00Z"

    Errors:
      type: object
      description: |
        # API Error Handling Strategy

          ## Overview

          This document defines the global error handling strategy for the API.
          All endpoints must comply with the rules described here.

          The goal is to provide a consistent and predictable error model for all API consumers.

          ## Authentication Errors

          ### 401 Unauthorized

          Returned when the request lacks valid authentication credentials.

          Typical scenarios:
          - Missing authentication token
          - Invalid or expired authentication token

          The client is expected to authenticate before retrying the request.


          ## Authorization Errors

          ### 403 Forbidden

          Returned when the user is authenticated but does not have permission to perform the requested action.

          Typical scenarios:
          - User attempts to access a resource they do not own
          - User role does not allow the operation


          ## Resource Errors

          ### 404 Not Found

          Returned when the requested resource does not exist or is not accessible to the user.

          This includes cases where the resource exists but the user is not authorized to know of its existence.

          This behavior prevents information leakage.


          ## Validation Errors

          ### 422 Unprocessable Entity

          Returned when the request payload is syntactically correct but fails domain validation rules.

          Typical scenarios:
          - Missing required fields
          - Invalid field formats
          - Business rule violations


          ## Successful Operations

          The API uses the following status codes for successful operations:

          - 200 OK: Successful read or update
          - 201 Created: Resource successfully created
          - 204 No Content: Resource successfully deleted


          ## Consistency Rules

          - All endpoints must use only the status codes defined in this document
          - No endpoint may introduce custom or undocumented error responses
          - Error responses must follow a consistent structure (to be defined during implementation)

    Users:
      type: object
      description: |
        # Users API Contract

          ## Resource Description

          The users resource represents system users.
          The API clearly distinguishes between self-service operations and administrative operations.


          ## Endpoints

          ### GET /api/v1/users/me

          **Purpose**  
          Retrieve the profile of the authenticated user.

          **Authorization**
          - user
          - admin

          **Status Codes**
          - 200 OK
          - 401 Unauthorized


          ### PUT /api/v1/users/me

          **Purpose**  
          Update the profile of the authenticated user.

          **Authorization**
          - user
          - admin

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 422 Unprocessable Entity


          ### GET /api/v1/users

          **Purpose**  
          List all users in the system.

          **Authorization**
          - admin only

          **Status Codes**
          - 200 OK
          - 401 Unauthorized
          - 403 Forbidden
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: John Doe
        email:
          type: string
          format: email
          example: john.doe@example.com
        role:
          type: string
          example: user
        created_at:
          type: string
          example: "2026-02-03T10:00:00.000000Z"
        updated_at:
          type: string
          example: "2026-02-03T10:00:00.000000Z"
    
    Security strategy:
      type: object
      description: |
        # Security Strategy

          ## Principles
          - The entire API will be protected by tokens.

          - Sessions are not used.

          - Authentication is based on OAuth2 using Laravel Passport.

          ## Separation of Duties
          - Authentication: who you are
          - Authorization: what you can do

          These responsibilities should not be mixed.

          ## Initial Roles
          - user: standard authenticated user
          - admin: global operational access

          ## Discarded Alternatives
          - Laravel Sanctum:

          - Does not fully meet the project's OAuth2 requirements.

          ## Note
          At this point, Passport is not installed or configured. Only the architectural decision is being made.

    Testing strategy:
      type: object
      description: |
        # Testing Strategy (TDD)

          ## Principles

          - Tests are the source of truth for the project.
          - No endpoint is considered finished without tests.
          - Behavior is defined before implementation.
          - Manual testing is not a validation mechanism.

          ## Testing framework

          - The project uses PHPUnit as the only testing framework.
          - PHPUnit is natively integrated with Laravel and provides explicit, predictable tests.
          - Mixing testing frameworks is not allowed.

          ## Testing environment

          All tests run in a dedicated testing environment:

          - APP_ENV=testing
          - Isolated database
          - Ephemeral cache, session, and queue drivers
          - No dependency on external services

          The testing environment is:

          - Reproducible
          - Disposable
          - Safe (cannot affect local or development data)

          ## Running tests

          The test suite is executed using:

          ```bash
          php artisan test

    Definition of done:
      type: object
      description: |
        # Definition of Done (DoD)

          A feature is considered complete only if it meets all the requirements of this checklist.

          ## Checklist
          - Written tests (if applicable)
          - Tests passed
          - Authorization applied correctly (if applicable)
          - Consistent error handling
          - Up-to-date documentation (if applicable)
          - Validated Postman collection (if applicable)
          - Branch ready for Pull Requests

          ## Objective
          - Avoid incomplete merges.

          - Maintain a stable `develop` environment.

          - Eliminate ambiguity about what "done" means.

    Domain:
      type: object
      description: |
        ## REST Resources

          ### User
          Represents an authenticable identity within the system.

          It does not represent a client or a CRM person, but rather the actor operating the system.

          ### Client
          Represents an entity managed by a user within the CRM.

          A client always exists within the context of a user.

          ### Activity
          Represents an action or interaction performed on a client (calls, meetings, notes, etc.).

          ## Responsibilities by Resource

          - User

              - Authentication

              - Role (user/admin)

              - Ownership of clients and activities

          - Client

              - Client data

              - Direct relationship with a user

          - Activity

              - Historical record of actions

              - Always associated with a client

              - Created by a user

          ## Domain Relationships

          - A user owns many clients
          - A client belongs to a user
          - A client has many activities
          - An activity belongs to a client
          - An activity is created by a user

          ## Access Rules by Role

          ### User
          - Can only access their own clients
          - Can only access their clients' activities
          - Cannot view or modify other users' data

          ### Admin
          - Global access to all resources
          - Can audit and manage any entity

          ## Business Logic (Beyond CRUD)

          - An activity cannot exist without a valid user client.
          - Statistics per client:

          - Total number of activities

          - Last recorded activity

    Database design:
      type: object
      description: |
        # Database Design — Relational Model

          ## Objective

          To define the relational model that supports the system's domain and REST contracts before implementing migrations or models.

          This document establishes tables, relationships, ownership, and integrity rules at a conceptual level, ensuring consistency with authorization and testing.

          ## Tables and Purpose

          ### users
          Represents authenticated system users.

          Responsibilities:
          - Authentication
          - Client ownership
          - Activity authorship

          ### clients
          Represents clients managed within the system.

          Responsibilities:
          - Contain client contact information
          - Serve as the primary context for activities

          ### activities
          Represents actions performed on a client.

          Responsibilities:
          - Register business events
          - Maintain historical traceability
          - Associate action, client, and creator user

          ## Relationships and Cardinalities

          ### users → clients (ownership)

          - A user can have multiple clients.

          - Each client belongs to only one user.

          Relationship:
          - 1 user → N clients

          Justification:
          This relationship defines the primary ownership of the domain and is the basis for the authorization rules: a user can only access their own clients.

          ### Clients → Activities

          - A client can have many activities.

          - Each activity belongs to a single client.

          Relationship:
          - 1 client → N activities

          Justification:
          - Activities without a client lose their meaning within the domain. This relationship guarantees traceability and business consistency.

          ### Users → Activities (Authorship)

          - A user can create many activities.

          - Each activity is created by a single user.

          Relationship:
          - 1 user → N activities

          Justification:
          - Clearly distinguishes between:
          - The client on whom the action is performed
          - The user who executes the action

          This allows for auditing, user-specific metrics, and future business rules.

          ## Ownership and Authorization

          - Primary ownership is established in the users → clients relationship.

          - Access to activities is always through the client.

          - - A user can only access:

          - Their own clients

          - The activities associated with those clients

          This design allows for the implementation of simple and verifiable authorization policies.

          ## Integrity Rules (Conceptual)

          The model must comply with the following rules:

          - A client cannot exist without a user.

          - An activity cannot exist without a client.

          - An activity cannot exist without a user creator.

          These rules must be enforced later at the database, application, or both levels.

          ## Testing Considerations

          The design allows for:

          - Simple creation of minimal data:

          - user

          - client associated with user

          - activity associated with client and user
          - Isolation of authorization scenarios:

          - user A cannot access user B's data
          - Avoidance of orphaned entities that complicate test cleanup

          This model is compatible with simple and predictable factories and seeders.

          ## Conscious Decisions

          - No additional technical columns are defined at this point.

          - No foreign keys or cascades are specified.

          - No premature optimizations (indexes, denormalization) are added.

          These decisions are postponed until the implementation phase.

          ## State

          This design validates the alignment between:
          - Domain
          - Persistence
          - Authorization
          - Testing

    Data strategy:
      type: object
      description: |
        # Data Strategy: Factories & Seeders

          ## Purpose

          This project uses a strict separation between factories and seeders to ensure:

          - Reliable and deterministic tests
          - Fast test execution
          - Clean separation between test data and development/demo data

          ---

          ## Factories

          Factories are designed as **scenario builders**, not random data generators.

          They are used to:

          - Create explicit ownership scenarios
          - Support authorization tests
          - Build complex relationships in a controlled way

          ### Rules

          - Factories are used by tests
          - Tests must create all required data explicitly
          - Factories must not contain business logic
          - Factories must not depend on seeders

          ### Available factories

          - UserFactory
          - ClientFactory (explicit user ownership)
          - ActivityFactory (explicit user + client relations)

          ---

          ## Seeders

          Seeders are intended **only for development and demo environments**.

          They are used to:

          - Populate local environments
          - Facilitate manual API exploration
          - Prepare data for Postman usage

          ### Rules

          - Seeders are never used in tests
          - Seeders may use factories internally
          - Seeder data must be reproducible and predictable

          ### Available seeders

          - DevelopmentUsersSeeder
          - DevelopmentClientsSeeder
          - DevelopmentActivitiesSeeder

          They are orchestrated by `DatabaseSeeder`.

          ---

          ## Running seeders (development only)

          ```bash
          php artisan migrate:fresh --seed

    Postman:
      type: object
      description: |
        ## Postman Usage

          Postman is used in this project only as a manual inspection and debugging tool.

          All API behavior is defined and validated by automated feature tests.
          Postman must never be used as the primary validation mechanism.

          ### When to use Postman

          - Inspect real JSON responses
          - Debug frontend integration issues
          - Manually test access tokens
          - Demonstrate API behavior

          ### When NOT to use Postman

          - To validate business rules
          - To test authorization logic
          - To replace automated tests
          - To define API behavior

          ### Setup

          1. Create a Postman environment with:
            - `api_url`
            - `token`
          2. Authenticate using the `/api/v1/login` endpoint
          3. Use the returned token for authenticated requests

          Postman collections are expected to reflect the documented API contract,
          not define it.

    Dashboard Response:
      type: object
      description: |
          # Dashboard API

            ## Overview

            The Dashboard API provides an aggregated, read-only view of key metrics and alerts for the authenticated user. It is designed to be lightweight, fast, and aligned with existing authorization rules. The dashboard does not represent a persistent entity and has no CRUD operations.

            ## Purpose

            * Provide a single endpoint for frontend dashboards
            * Reduce round-trips by aggregating counters and alerts
            * Respect ownership and role-based access (user vs admin)
            * Avoid introducing new domain entities or persistence

            ## Endpoint

            ```
            GET /api/v1/dashboard
            ```

            ## Authentication

            * Required: Bearer token (OAuth2 via Passport)
            * Unauthorized requests return `401`

            ## Authorization Rules

            ### User

            * `clients_count`: number of clients owned by the user
            * `activities_count`: number of activities associated with the user's clients
            * `pending_activities_alerts`: pending activities associated with the user's clients

            ### Admin

            * `clients_count`: total number of clients
            * `activities_count`: total number of activities
            * `pending_activities_alerts`: all pending activities

            ## Definition of "Pending Activity"

            An activity is considered **pending** when:

            * `completed_at` is `NULL`

            This rule is explicit, testable, and intentionally simple. Additional alert types may be introduced in the future.

            ## Response Format

            ```json
            {
              "clients_count": 5,
              "activities_count": 12,
              "pending_activities_alerts": [
                {
                  "activity_id": 42
                }
              ]
            }
            ```

            ### Fields

            * `clients_count` *(integer)*: Number of visible clients
            * `activities_count` *(integer)*: Number of visible activities
            * `pending_activities_alerts` *(array)*: List of pending activity alerts

            Each alert currently contains:

            * `activity_id`: Identifier of the pending activity

            ## Status Codes

            * `200 OK`: Dashboard loaded successfully
            * `401 Unauthorized`: Missing or invalid authentication token

            ## Design Notes

            * Read-only endpoint
            * No pagination (expected low alert volume)
            * No caching (premature at this stage)
            * No real-time updates or events
            * No per-widget endpoints

            ## Testing

            The dashboard behavior is fully defined by feature tests covering:

            * Authentication (401 without token)
            * User vs admin visibility
            * Correct counters per role
            * Explicit pending activity rule

            ## Evolution

            This endpoint is intentionally designed to grow by adding new widgets or fields to the response without breaking existing consumers.
      properties:
        clients_count:
          type: integer
          description: Number of clients visible to the authenticated user
          example: 5
        activities_count:
          type: integer
          description: Number of activities visible to the authenticated user
          example: 12
        pending_activities_alerts:
          type: array
          description: List of pending activity alerts
          items:
            $ref: '#/components/schemas/PendingActivityAlert'


security:
  - BearerAuth: []

paths:
  /login:
    post:
      summary: User login
      tags: [Authentication]
      description: Authenticates a user and returns an access token.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: password
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "422":
          description: Invalid credentials (validation error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

  /me:
    get:
      summary: Health/auth check
      tags: [Authentication]
      description: "Returns { ok: true } when the request is authenticated."
      responses:
        "200":
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /clients:
    get:
      summary: List clients
      tags: [Clients]
      description: Returns clients visible to the authenticated user.
      responses:
        "200":
          description: Clients list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientCollection"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create client
      tags: [Clients]
      description: Creates a new client owned by the authenticated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientCreateRequest"
      responses:
        "201":
          description: Client created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

  /clients/{id}:
    get:
      summary: Get client
      tags: [Clients]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      responses:
        "200":
          description: Client found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update client
      tags: [Clients]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClientUpdateRequest"
      responses:
        "200":
          description: Client updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
    delete:
      summary: Delete client
      tags: [Clients]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      responses:
        "204":
          description: Client deleted
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /activities:
    get:
      summary: List activities
      tags: [Activities]
      description: Returns activities visible to the authenticated user.
      responses:
        "200":
          description: Activities list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivityCollection"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create activity
      tags: [Activities]
      description: Creates a new activity for a client.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ActivityCreateRequest"
      responses:
        "201":
          description: Activity created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivityResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

  /activities/{id}:
    get:
      summary: Get activity
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      responses:
        "200":
          description: Activity found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivityResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update activity
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ActivityUpdateRequest"
      responses:
        "200":
          description: Activity updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivityResource"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
    delete:
      summary: Delete activity
      tags: [Activities]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
          example: 1
      responses:
        "204":
          description: Activity deleted
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /dashboard:
    get:
      summary: Aggregated dashboard
      description: >
        Returns aggregated counters and pending activity alerts according to the
        authenticated user's role. This is a read-only endpoint.
      tags:
        - Dashboard
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard loaded successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - clients_count
                  - activities_count
                  - pending_activities_alerts
                properties:
                  clients_count:
                    type: integer
                    description: Number of clients visible to the authenticated user
                    example: 5
                  activities_count:
                    type: integer
                    description: Number of activities visible to the authenticated user
                    example: 12
                  pending_activities_alerts:
                    type: array
                    description: List of pending activity alerts
                    items:
                      type: object
                      required:
                        - activity_id
                      properties:
                        activity_id:
                          type: integer
                          description: Identifier of the pending activity
                          example: 42
        '401':
          description: Unauthorized authentication token is missing or invalid

  /users/me:
    get:
      summary: Get own user profile
      description: |
        Returns the authenticated user's own profile.
        Accessible by USER and ADMIN roles.
      tags:
        - Users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Own user profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/User"
        "401":
          description: Unauthenticated

  /users:
    get:
      summary: List users (admin only)
      description: |
        Returns a list of users.
        Accessible only by ADMIN role.
      tags:
        - Users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
        "401":
          description: Unauthenticated
        "403":
          description: Forbidden

  /users/{id}:
    get:
      summary: Get user by id (admin only)
      description: |
        Returns a specific user by id.
        Accessible only by ADMIN role.
        Returns 404 only if the user does not exist and the requester is admin.
      tags:
        - Users
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: User found
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/User"
        "401":
          description: Unauthenticated
        "403":
          description: Forbidden
        "404":
          description: User not found
